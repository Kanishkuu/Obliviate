version: "3.9"
services:
  redis:
    image: redis:7
    ports: ["6379:6379"]

  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    env_file: ../.env
    volumes:
      - ../runs:/app/runs
      - ../uploads:/app/uploads
      - ../.hf_cache:/app/.hf_cache
    ports:
      - "${API_PORT:-8000}:8000"
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - capabilities: [gpu]

  worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.worker
    env_file: ../.env
    depends_on: [redis]
    volumes:
      - ../runs:/app/runs
      - ../uploads:/app/uploads
      - ../.hf_cache:/app/.hf_cache
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - capabilities: [gpu]
